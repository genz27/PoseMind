## 问题与目标
- 生成的姿势示意图出现“三只手”等解剖错误。
- 后端需限制“每个 session 用户每天最多使用 20 次”。
- 完成优化后提交并推送至 GitHub。

## Prompt 优化（重点针对解剖与风格）
- 位置：线条示意图提示 `config.py` 的 `ILLUSTRATION_PROMPT_TEMPLATE`（当前已集中管理）与 `app.py:206-210` 使用处。
- 增强约束（加入到正向提示文本中）：
  - 解剖正确：四肢数量正常（两臂两腿），无多手/多指/多腿/多脸；无肢体融合或断裂。
  - 手部细节：五指、数量正确；手指不粘连、不畸形；避免复杂手部特写，采用简化轮廓。
  - 姿势合理：关节角度合乎常识；无不可能的扭曲或过度弯曲；左右手与左右腿不混淆。
  - 风格限定：黑白线条、白色纯背景、均匀线宽；不写实、不3D、不彩色；不含文字/水印/Logo/复杂背景/阴影。
  - 教学属性：突出关键部位与肢体走向，清晰、简洁、可复现。
- 负面约束（直接并入提示文本；若 API 支持 `negative_prompt` 再并行传入）：
  - 负面：真实照片、复杂背景、彩色、文字、水印、Logo、阴影、3D、写实、多肢体、多手指、解剖错误、肢体融合、重影、透视混乱。
- 其他两处提示：
  - 姿势建议（`config.py` 的 `POSE_USER_PROMPT_TEMPLATE` 与 `app.py:431-439`）中加入“不生成不可能/危险动作、避免遮挡面部的手部特写、保证解剖与动作可实现”的约束。
  - 场景分析（`config.py` 的 `SCENE_ANALYSIS_*` 与 `app.py:102-126`）保持结构化输出，便于后续解析与校验。

## 后端会话日配额限制（20 次/天）
- 位置：`app.py:336-396` 的 `/api/generate-poses` 入口。
- 实现要点：
  - 启用 Flask 会话：在 `app.py` 引入 `from flask import session`；在 `config.py` 增加 `SECRET_KEY`（从环境读取）。
  - 会话计数结构：`session['usage_date']`（字符串 `YYYY-MM-DD`）与 `session['usage_count']`（整数）。
  - 每次请求：如果日期变更则重置计数为 0；若计数 >= 20，返回 `429` 与中文错误 `今日次数已用完（20/20），请明日再试`；否则自增并继续处理。
  - 作用范围：仅限制 `/api/generate-poses`，上传不计数（避免影响基础使用）。
  - 安全与稳定：确保 `SECRET_KEY` 不能为空；错误情况下不泄露内部信息。

## 校验与回退
- 单元校验（轻量）：
  - 构造 1 次超过 20 次的快速请求，验证 429 与计数重置逻辑（日期切换）。
  - 对 AI 返回进行 JSON 解析与枚举校验，失败走本地 fallback（现已存在）。
- 运行验证：本地导入与简易路由访问，避免语法与依赖错误。
- 回退策略：如提示约束导致生成失败率显著上升，逐步收敛负面条款；保留当前稳定版本。

## 代码改动点
- `config.py`
  - 新增 `SECRET_KEY` 环境变量读取与默认占位。
  - 扩充 `ILLUSTRATION_PROMPT_TEMPLATE` 与 `POSE_USER_PROMPT_TEMPLATE` 的解剖与负面约束文案。
- `app.py`
  - `generate_poses` 入口处加入会话配额校验与计数更新。
  - 引入 `session` 并设置 `app.secret_key = config.SECRET_KEY`。
  - 姿势与示意图的提示引用统一从 `config` 读取。

## 提交与推送
- 创建两次提交：
  - 提交 1：Prompt 强化与结构化约束（场景/姿势/示意图）。
  - 提交 2：会话日配额限制（20 次/天）与错误提示。
- 推送到远程 `origin/main`。

## 交付内容
- 改进后的提示与后端限流逻辑已实现并验证。
- 代码位置说明与未来可迭代点（如负面提示专用字段、A/B 测试切换）。

请确认上述方案，我将开始实现、验证并推送。