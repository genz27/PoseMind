## 目标与原则
- 明确与可控：输出结构稳定、字段边界清晰、避免冗余与跑题。
- 可解析与可测试：严格 JSON，仅中文，无 Markdown 包裹，长度与枚举可验证。
- 安全与健康：强调专业、健康、优雅的指导，不生成不当内容。
- 成本与性能：尽量短促、指令化，降低大模型推理负担与失败率。

## 涉及位置
- 场景分析提示：`app.py:103-111`
- 姿势建议提示：`app.py:433-457`
- 线条示意图提示：`app.py:206-216`

## 优化方案
### 场景分析（严格 JSON 输出）
- 系统消息（新增）：
  "你是摄影场景分析助手。必须只输出合法 JSON；不得输出解释、Markdown、额外文本；不确定时用 \"未知\"。"
- 用户消息（替换现有文本）：
  "请基于所给图片输出一个 JSON 对象，字段与要求如下：\n- location_type：场所类型（室内|户外|城市|自然|建筑|商业|住宅），最多6字\n- scene：具体场景（如咖啡馆、公园、街道、海边、办公室、家中等），最多8字\n- ambiance：氛围（休闲|正式|浪漫|活力|艺术|安静|热闹），最多6字\n- lighting：光线（自然光|人工光|逆光|柔光|硬光|混合光），最多6字\n- style_advice：拍摄风格建议，12-30字\n输出要求：仅返回 JSON；全部为简体中文；不得臆测。"
- 期望输出示例（仅作为开发内测参考，不放入提示中）：
  {"location_type":"户外","scene":"公园","ambiance":"休闲","lighting":"自然光","style_advice":"选择柔和色调与浅景深，突出人物与背景层次"}

### 姿势建议（结构化数组 + 严格枚举）
- 系统消息（新增）：
  "你是专业摄影指导。必须只输出合法 JSON 数组；长度为 N（代码传入）；不得输出解释或 Markdown；内容专业、健康、优雅。"
- 用户消息（替换现有文本）：
  "根据以下场景分析与性别，为人物生成 N 个可实现的摄影姿势，返回 JSON 数组。\n每个元素包含：\n- name：姿势名称，≤12字，中文，不含性别后缀\n- description：详细动作说明，40-120字，覆盖身体、手臂、腿部、头部与表情要点，可包含道具/环境互动\n- category：类别（经典|动态|坐姿|情感|艺术|互动|时尚|倚靠）\n约束：仅返回 JSON；不得包含英文、emoji、Markdown；避免不当内容与暗示。\n输入：<粘贴场景分析文本>，性别：<女生/男生>"
- 解析兼容：保留现有性别后缀追加逻辑；若未来稳定，可直接要求不追加后缀（已在上方约束）。

### 线条示意图（更强的风格与负面约束）
- 用户提示（替换现有 `illustration_prompt` 文案）：
  "黑白线条教学示意图，单人，{性别}人物；居中构图，白色纯背景；线宽均匀、简洁清晰，突出姿势关键部位与肢体走向；不写实、不照片风、不3D、不彩色；不包含文字、水印、Logo、复杂背景与阴影；风格专业、健康、优雅，适合摄影教学。"
- 如 API 支持，可增加负面提示（仅当模型参数允许）：
  "负面：真实照片、复杂背景、彩色、文字、水印、Logo、阴影、3D、写实。"

## 技术实现要点
- 在 `chat/completions` 的 `messages` 中新增 `system` 角色消息以强约束输出格式（若服务支持）。
- 将三段提示移至 `config.py` 常量，便于版本化与 A/B 测试。
- 对姿势 JSON 解析增加校验：字段存在性、枚举合法性、长度边界；失败走本地 fallback（现有已部分覆盖）。
- 统一中文与长度约束，避免模型输出超长文本导致 UI 拖沓与截断。

## 验证与回滚
- 构造 3 张测试图片（室内/户外/城市），分别跑：场景分析→姿势生成→示意图生成；记录耗时、失败率与解析通过率。
- 新增轻量单元测试：JSON 解析与枚举校验、长度断言；日志仅保留必要字段（状态码、task_id）。
- 若出现输出夹杂非 JSON 或枚举不合法，首先调整系统消息与长度；必要时回退至当前稳定提示。

## 下一步实施
- 将上述三处提示替换为新文本，并在后端增加 `system` 消息（若兼容）。
- 增加解析校验与单测，打通端到端本地验证；记录对比数据。
- 如验证通过，创建提交并推送。